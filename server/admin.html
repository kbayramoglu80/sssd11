<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luxen Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: radial-gradient(1400px 700px at -10% -10%, #1e293b33, transparent 60%), radial-gradient(1000px 500px at 110% 110%, #1f293733, transparent 60%), linear-gradient(180deg, #0a0e19 0%, #0a0f1c 100%); color: #e5e7eb; font-family: 'Poppins', sans-serif; }
    .table-container { max-width: 1200px; margin: 40px auto; background: #0f172a; border: 1px solid #1f2a44; border-radius: 16px; box-shadow: 0 20px 60px #0007; padding: 24px 16px; }
    .header { font-size: 2rem; font-weight: 800; background: linear-gradient(90deg,#D4AF37,#fef3c7,#D4AF37); -webkit-background-clip:text; background-clip:text; color:transparent; letter-spacing: 1px; }
    th { background: #D4AF37; color: #111827; font-weight: 800; position: sticky; top: 0; z-index: 1; }
    td, th { padding: 10px 8px; text-align: left; }
    tr { background:#0b1324; border-bottom: 1px solid #1f2a44; }
    tr:nth-child(even) { background:#0d152a; }
    .no-data { text-align: center; color: #94a3b8; margin: 24px 0; font-size: 1rem; }
    .search-bar { margin: 18px 0 12px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
    .search-bar input, .search-bar select { color: #e5e7eb; background: #0b1220; border:1px solid #243244; border-radius: 8px; padding: 10px 12px; font-size: 0.95rem; }
    .search-bar input:focus, .search-bar select:focus { border-color:#D4AF37; outline:none; box-shadow:0 0 0 3px rgba(212,175,55,.15) }
    .search-bar label { color: #D4AF37; font-weight: 600; margin-right: 4px; }
    .btn-delete { background: #D4AF37; color: #111827; border: none; border-radius: 8px; padding: 6px 14px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .btn-delete:hover { filter: brightness(1.05); }
    .btn-home { background:#0b1220; color:#e5e7eb; border:1px solid #1f2a44; font-weight:600; border-radius:8px; font-size:0.95rem; padding:8px 14px; }
    .btn-logout { background:#D4AF37; color:#111827; font-weight:700; border-radius:8px; font-size:0.95rem; padding:8px 14px; }
  </style>
</head>
<body>
  <div class="table-container">
    <div class="flex items-center justify-between mb-2">
      <span class="header">Luxen Admin • Rezervasyonlar</span>
      <div class="flex gap-2">
        <a href="/index.html" class="btn-home">Ana Sayfaya Dön</a>
        <button id="logoutBtn" class="btn-logout">Çıkış Yap</button>
      </div>
    </div>
    <div class="search-bar">
      <div class="flex items-center gap-2">
        <label for="search">Arama:</label>
        <input type="text" id="search" placeholder="İsim, soyad, kişi sayısı, telefon...">
      </div>
      <div class="flex items-center gap-2">
        <label for="type-filter">Tip:</label>
        <select id="type-filter">
          <option value="">Tümü</option>
          <option value="TRANSFER">TRANSFER</option>
          <option value="ŞOFÖRLÜ ARAÇ KİRALAMA">ŞOFÖRLÜ ARAÇ KİRALAMA</option>
          <option value="ŞEHİRLER ARASI TRANSFER">ŞEHİRLER ARASI TRANSFER</option>
        </select>
      </div>
    </div>
    <table class="w-full text-sm">
      <thead>
        <tr>
          <th>#</th>
          <th>İsim</th>
          <th>Soyad</th>
          <th>Kişi Sayısı</th>
          <th>Telefon</th>
          <th>Tarih</th>
          <th>Saat</th>
          <th>Başlangıç</th>
          <th>Varış</th>
          <th>Mesafe (km)</th>
          <th>Tip</th>
          <th>Oluşturma</th>
          <th>Sil</th>
        </tr>
      </thead>
      <tbody id="reservations-body">
        <tr><td colspan="13" class="no-data">Yükleniyor...</td></tr>
      </tbody>
    </table>
  </div>
  <script>
    document.getElementById('logoutBtn').addEventListener('click', async function() {
      try {
        await fetch('/admin/logout', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
      } finally {
        window.location.href = '/admin/login';
      }
    });

    let allReservations = [];
    async function fetchReservations() {
      try {
        const res = await fetch('/api/reservations');
        if (res.status === 401) {
          window.location.href = '/admin/login';
          return;
        }
        const data = await res.json();
        allReservations = data.reverse();
        renderTable();
      } catch (err) {
        document.getElementById('reservations-body').innerHTML = '<tr><td colspan="13" class="no-data">Veri alınamadı.</td></tr>';
      }
    }
    function renderTable() {
      const tbody = document.getElementById('reservations-body');
      const search = document.getElementById('search').value.toLowerCase();
      const type = document.getElementById('type-filter').value;
      let filtered = allReservations.filter(r => {
        let match = true;
        if (search) {
          match = (
            (r.isim || '').toLowerCase().includes(search) ||
            (r.soyad || '').toLowerCase().includes(search) ||
            (String(r.yolcu || '')).toLowerCase().includes(search) ||
            (r.telefon || '').toLowerCase().includes(search) ||
            (r.from || '').toLowerCase().includes(search) ||
            (r.to || '').toLowerCase().includes(search)
          );
        }
        if (type && r.rezervasyonTipi !== type) match = false;
        return match;
      });
      tbody.innerHTML = '';
      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="13" class="no-data">Kayıt bulunamadı.</td></tr>';
        return;
      }
      filtered.forEach((r, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.isim || ''}</td>
          <td>${r.soyad || ''}</td>
          <td>${r.yolcu || ''}</td>
          <td>${r.telefon || ''}</td>
          <td>${r.tarih || ''}</td>
          <td>${r.saat || ''}</td>
          <td>${r.from || ''}</td>
          <td>${r.to || ''}</td>
          <td>${r.distance ? Number(r.distance).toFixed(2) : ''}</td>
          <td>${r.rezervasyonTipi || ''}</td>
          <td>${r.createdAt ? new Date(r.createdAt).toLocaleString('tr-TR') : ''}</td>
          <td><button class="btn-delete" onclick="deleteReservation('${r.id}')">Sil</button></td>
        `;
        tbody.appendChild(tr);
      });
    }
    async function deleteReservation(id) {
      if (!confirm('Bu rezervasyonu silmek istediğinize emin misiniz?')) return;
      try {
        const res = await fetch(`/api/reservations/${id}`, { method: 'DELETE' });
        if (res.status === 401) {
          window.location.href = '/admin/login';
          return;
        }
        const result = await res.json();
        if (result.success) {
          allReservations = allReservations.filter(r => r.id != id);
          renderTable();
        } else {
          alert('Silme işlemi başarısız!');
        }
      } catch {
        alert('Silme işlemi sırasında hata oluştu!');
      }
    }
    document.getElementById('search').addEventListener('input', renderTable);
    document.getElementById('type-filter').addEventListener('change', renderTable);
    fetchReservations();
  </script>
</body>
</html>


